(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const c of n)if(c.type==="childList")for(const s of c.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function r(n){const c={};return n.integrity&&(c.integrity=n.integrity),n.referrerPolicy&&(c.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?c.credentials="include":n.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function o(n){if(n.ep)return;n.ep=!0;const c=r(n);fetch(n.href,c)}})();const W=document.querySelector(".content"),u=document.querySelector(".control"),a={refreshBGButton:u.querySelector(".control__refresh-BG-button"),refreshBG:u.querySelector(".control__refresh-BG-img"),changeLanguage:u.querySelector(".control__change-language"),nameLanguage:u.querySelector(".control__name-language"),hiddenListLanguages:u.querySelector(".control__hidden-list-languages"),hiddenElementsLanguage:u.querySelectorAll(".control__hidden-element-language"),hiddenElementLanguageName:u.querySelectorAll(".control__hidden-element-language-name"),changeTemperature:u.querySelector(".control__change-temperature"),typesTemperature:u.querySelectorAll(".control__type-temperature"),faringate:u.querySelector(".control__faringate"),celsius:u.querySelector(".control__celsius"),searchBar:u.querySelector(".control__search-bar"),searchCityInput:u.querySelector(".control__search-city-input"),searchCityIcon:u.querySelector(".control__search-city-icon"),searchCityButton:u.querySelector(".control__search-city-button")},g=document.querySelector(".today-weather"),l={city:g.querySelector(".today-weather__city"),country:g.querySelector(".today-weather__country"),todayDate:g.querySelector(".today-weather__today-date"),todayTime:g.querySelector(".today-weather__today-time"),numTemperatureToday:g.querySelector(".today-weather__num-temperature-today"),weatherIcon:g.querySelector(".today-weather__weather-icon"),weatherCondition:g.querySelector(".today-weather__weather-condition"),perceivedTemperatureNum:g.querySelector(".today-weather__perceived-temperature-num"),windSpeedNum:g.querySelector(".today-weather__wind-speed-num"),humidityNum:g.querySelector(".today-weather__humidity-num")},j=document.querySelector(".upcoming-forecast"),S=[...j.querySelectorAll(".day")],w=document.querySelector(".map"),q={latitudeLabel:w.querySelector(".map__latitude-name"),longitudeLabel:w.querySelector(".map__longitude-name"),latitudeValue:w.querySelector(".map__latitude-num"),longitudeValue:w.querySelector(".map__longitude-num")},C=document.querySelector(".error-container"),U=document.querySelector(".error-message__button");async function A(e){try{const t=await fetch(`https://cors-proxy-server-0jmy.onrender.com/${e}`);if(!t.ok)throw new Error(`${e} fetch error: ${t.status}`);const r=await t.json();if(!r||!r.apiKey)throw new Error(`${e} invalid response`);return r.apiKey}catch(t){return console.error(`Ошибка получения ключа (${e}):`,t),null}}const V=()=>A("getApiKey"),J=()=>A("getUnsplashApiKey");function z(e,t,r){const o=JSON.parse(localStorage.getItem(e))||[];o[r]=t,localStorage.setItem(e,JSON.stringify(o))}function m(e,t){typeof t=="string"?localStorage.setItem(e,t):localStorage.setItem(e,JSON.stringify(t))}function i(e,t=null){const r=localStorage.getItem(e);if(r===null)return t;try{return JSON.parse(r)}catch{return r}}let p=[],y=Number(localStorage.getItem("currentBG_Img_Index"))||0;const I=a.refreshBGButton;I.classList.add("control__refresh-BG_loading");I.disabled=!0;async function H({isInitialLoad:e=!1,isCityChanged:t=!1}={}){try{t&&(p=[],y=0,localStorage.setItem("currentBG_Img_Index",y));const r=await J(),o=`https://api.unsplash.com/search/photos?query=${i("city")}&client_id=${r}&per_page=6`,n=await fetch(o);if(!n.ok)throw new Error("Could not fetch weather data");const c=await n.json();p=c.results,console.log("Изображения загружены:",p),console.log("Данные BG",c);const s=e?y%p.length:y;D(s),a.refreshBGButton.classList.remove("control__refresh-BG_loading"),a.refreshBGButton.disabled=!1,a.refreshBG.classList.remove("hidden-by-visibility")}catch(r){console.error("Ошибка при загрузке изображений:",r.message)}}function D(e){var r,o;console.log(e);const t=(o=(r=p[e])==null?void 0:r.urls)==null?void 0:o.regular;t&&(W.style.backgroundImage=`url(${t})`)}function Z(){if(console.log("REFRESH"),!p.length){console.log("Фоновые изображения ещё не загружены.");return}y=(y+1)%p.length,localStorage.setItem("currentBG_Img_Index",y),D(y)}I.addEventListener("click",Z);function Q(){const e=a.searchBar.querySelector(".control__ErrorMessage");e&&(a.searchCityInput.classList.remove("control__search-city-input_error"),e.remove())}function T(e){const t=a.searchBar.querySelector(".control__ErrorMessage");if(t)t.innerText=e;else{a.searchCityInput.classList.add("control__search-city-input_error");const r=document.createElement("p");r.textContent=e,r.classList.add("control__ErrorMessage"),a.searchBar.appendChild(r)}}function x(e){console.log(e),C&&C.classList.remove("hidden-by-display")}U.addEventListener("click",function(){location.reload()});function X(e){return!(!e||typeof e.name!="string"||!e.main||typeof e.main.temp!="number"||!e.wind||typeof e.wind.speed!="number"||!Array.isArray(e.weather)||!e.weather[0]||typeof e.weather[0].description!="string")}let _;function Y(e,t){_&&_.remove(),_=L.map("map").setView([e,t],10),L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CartoDB</a>'}).addTo(_),L.marker([e,t]).addTo(_).bindPopup("Выбранный город").openPopup(),q.latitudeValue.innerText=$(e),q.longitudeValue.innerText=$(t)}function $(e){const t=Math.floor(e),r=(e-t)*60,o=Math.floor(r),n=Math.round((r-o)*60);return`${t}°${o}'${n}"`}function ee(e,t){const r=new Date(Date.now()+e*1e3),o={weekday:"short",day:"numeric",month:"long",hour:"2-digit",minute:"2-digit",hour12:!1,timeZone:"UTC"};return r.toLocaleDateString(t,o).replace(",","").replace(" at","").split(" ")}function h(e){const t=i("currentTypeTemperature");if(t==="metric")return Math.round(e);if(t==="imperial")return Math.round(e*9/5+32)}a.hiddenElementsLanguage.forEach(function(e){const t=e.querySelector(".control__hidden-element-language-name");console.log("elNameLanguage.innerText: ",t.innerText),console.log(i("language")),t.innerText===i("language")?(e.classList.add("control__hidden-element-language_selected"),a.nameLanguage.innerText=i("language")):e.classList.remove("control__hidden-element-language_selected")});const te={en:{Latitude:"Latitude",Longitude:"Longituded"},es:{Latitude:"Latitud",Longitude:"Longitud"},ru:{Latitude:"Широта",Longitude:"Долгота"}};function b(e,t){return te[t][e]}a.changeLanguage.addEventListener("click",e=>re(e));async function re(e){if(a.hiddenListLanguages.classList.toggle("hidden-by-display"),!e.target.closest(".control__hidden-element-language"))return;const t=e.target.closest(".control__hidden-element-language");t.querySelector(".control__hidden-element-language-name").innerText!==a.nameLanguage.innerText&&(a.hiddenElementsLanguage.forEach(function(r){r.classList.remove("control__hidden-element-language_selected")}),t.classList.add("control__hidden-element-language_selected"),a.nameLanguage.innerText=t.querySelector(".control__hidden-element-language-name").innerText,m("language",a.nameLanguage.innerText),console.log("controlDomElements.nameLanguage.innerText: ",a.nameLanguage.innerText),console.log(i("language")),await v({city:i("city"),isInitialLoad:!1,isCityChanged:!0,currentLanguage:i("language")}),q.latitudeLabel.innerText=b("Latitude",a.nameLanguage.innerText.toLowerCase()),q.longitudeLabel.innerText=b("Longitude",a.nameLanguage.innerText.toLowerCase()))}function ne(){console.log(l.city.innerText),fetch(`https://cors-proxy-server-0jmy.onrender.com/geonames?city=${l.city.innerText}&lang=${i("language").toLowerCase()}`).then(e=>e.json()).then(e=>{e&&e.geonames&&Array.isArray(e.geonames)&&e.geonames.length>0?l.city.innerText=e.geonames[0].name:(console.error("Ошибка: geonames не содержит данных",e),showErrorOverlay())}).catch(e=>console.error("Ошибка:",e))}function oe(){i("currentTypeTemperature")||m("currentTypeTemperature","metric"),i("currentTypeTemperatureName")||m("currentTypeTemperatureName","°C"),i("language")||m("language","EN")}oe();const B="https://api.openweathermap.org/data/2.5";a.searchBar.addEventListener("submit",e=>ae(e));async function ae(e){e.preventDefault();const t=a.searchCityInput.value.trim();await v({city:t,isInitialLoad:!1,isCityChanged:!0})}function ce(){Q(),a.searchCityInput.value=""}async function v({city:e,isInitialLoad:t=!1,isCityChanged:r=!1,currentLanguage:o=i("language")}){if(!e)return T("Пожалуйста, введите город");try{const[n,c]=await ie({curLangue:o,units:"metric",city:e});if(!n||!c||!c.list||!Array.isArray(c.list)||!n.main)return T("Не удалось найти данные по введённому городу.");se(n,o);const s=c==null?void 0:c.list.filter(d=>d.dt_txt.includes("12:00:00"));if(s.length<4)return x();S.forEach((d,f)=>{s[f+1]?de(s[f+1],f,o):x()}),ce(),m("city",n.name),await H({isInitialLoad:t,isCityChanged:r})}catch{T("Не удалось найти данные по введённому городу.")}}async function ie({curLangue:e,typeTemp:t="metric",city:r}){const o=await V(),[n,c]=await Promise.all([fetch(`${B}/weather?q=${r}&appid=${o}&units=${t}&lang=${e}`),fetch(`${B}/forecast?q=${r}&appid=${o}&units=${t}&lang=${e}`)]);if(!n.ok||!c.ok)throw new Error("Could not fetch weather data");const[s,d]=await Promise.all([n.json(),c.json()]);if(!s||!d)throw x(),new Error("Некорректные данные от API");return[s,d]}function se(e,t){const r=e.sys.country,o=new Intl.DisplayNames([t],{type:"region"}).of(r),[n,c,s,d]=ee(e.timezone,t),{name:f,wind:{speed:M},main:{temp:k,feels_like:O,humidity:P},weather:[{description:E,icon:F}],coord:{lat:R,lon:K}}=e;if(!X(e))return T("Данные от API повреждены или устарели");l.city.innerText=f,l.country.innerText=o,l.todayDate.innerText=`${n} ${s} ${c}`,l.todayTime.innerText=d,l.weatherCondition.innerText=E,l.windSpeedNum.innerText=M,l.humidityNum.innerText=P,m("city",e.name),ne(),le(F,E),ue(k,O),me(R,K)}function le(e,t){const r=e;l.weatherIcon.src=`https://openweathermap.org/img/wn/${r}@2x.png`,l.weatherIcon.alt=t,l.weatherIcon.removeAttribute("style")}function ue(e,t){const r=h(e),o=h(t);m("tempTodayC",e),m("tempfeelsLikeC",t),l.numTemperatureToday.innerText=r,l.perceivedTemperatureNum.innerText=o}function me(e,t){m("latitude",e),m("longitude",t),Y(i("latitude"),i("longitude"))}function de(e,t,r){const o=new Date(e.dt_txt).toLocaleDateString(r,{weekday:"short"}),n=h(e.main.temp),c=`https://openweathermap.org/img/wn/${e.weather[0].icon}@2x.png`;z("tempOtherDays",e.main.temp,t);const s=S[t];s.querySelector(".day__day-week").innerText=o,s.querySelector(".day__num-temperature").innerText=n;const d=s.querySelector(".day__weather-icon");d.src=c,d.removeAttribute("style")}const ge=i("city")||"Moscow";window.addEventListener("load",async()=>{await v({city:ge,isInitialLoad:!0})});function G(e){a.typesTemperature.forEach(function(r){r.classList.remove("control__type-temperature_selected-type")});const t=a.changeTemperature.querySelector(`.control__${e}`);t==null||t.classList.add("control__type-temperature_selected-type")}G(i("currentTypeTemperatureName"));a.changeTemperature.addEventListener("click",function(e){const t=e.target.closest(".control__type-temperature");if(!t||t.classList.contains("control__type-temperature_selected-type"))return;const r=t.classList.contains("control__faringate"),o=r?"imperial":"metric",n=r?"faringate":"celsius";G(n),m("currentTypeTemperature",o),m("currentTypeTemperatureName",n),console.log(o),console.log(n),ye()});function ye(){l.numTemperatureToday.innerText=h(i("tempTodayC")),l.perceivedTemperatureNum.innerText=h(i("tempfeelsLikeC")),console.log(i("tempTodayC")),console.log(i("tempfeelsLikeC"));const e=i("tempOtherDays");console.log("arrDays: ",e),S.forEach(function(t){t.querySelector(".day__num-temperature").innerText=h(e.shift()),console.log("day: ",t)}),console.log("arrDays: ",e),console.log("upcomingForecastDays: ",S)}const N=window.SpeechRecognition||window.webkitSpeechRecognition;if(N){const e=new N;e.interimResults=!1,e.maxAlternatives=1,a.searchCityIcon.addEventListener("click",()=>{e.lang=`${i("language").toLowerCase()}-${i("language")}`,console.log(`${i("language").toLowerCase()}-${i("language")}`),e.start(),a.searchCityInput.value="🎙️ Говорите..."}),e.addEventListener("result",t=>{const r=t.results[0][0].transcript.trim();a.searchCityInput.value=r,console.log("Распознанный текст:",r),e.stop(),a.searchCityButton.click()}),e.addEventListener("error",t=>{console.error("Ошибка распознавания:",t.error),alert("Ошибка распознавания речи. Попробуйте снова."),a.searchCityInput.value="🎤"})}else console.warn("Web Speech API не поддерживается в этом браузере"),alert("Ваш браузер не поддерживает голосовой ввод 😢");
